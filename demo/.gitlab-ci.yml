stages:
  - security-scan
  - spha-scan

# Run OSV Scanner
osv-scanner:
  stage: security-scan
  image:
    name: ghcr.io/google/osv-scanner:latest
    entrypoint: [""]  # <--- FORCE ENTRYPOINT RESET
  tags:
    - shared
  script:
    # Added --format=json and redirection to create the actual file
    - /osv-scanner --recursive --format=json . > osv-scanner-report.json
  allow_failure: true
  artifacts:
    when: always
    paths:
      - osv-scanner-report.json
    expire_in: 1 week
    # Note: 'gl-dependency-scanning-report.json' removed.
    # OSV output is not natively compatible with GitLab's Security Dashboard format.
  only:
    - branches
    - merge_requests

# Run TruffleHog
trufflehog:
  stage: security-scan
  image:
    name: trufflesecurity/trufflehog:latest
    entrypoint: [""] # <--- FORCE ENTRYPOINT RESET
  tags:
    - shared
  script:
    - trufflehog git file://. --json --no-update > trufflehog-report.json
  allow_failure: true
  artifacts:
    paths:
      - trufflehog-report.json
    expire_in: 1 week
  only:
    - branches
    - merge_requests

# Run SPHA-CLI to collect the results and send to our server
spha-cli:
  stage: spha-scan
  image: eclipse-temurin:25
  tags:
    - shared
  before_script:
    - apt-get update && apt-get install -y git
  script:
    - echo "Running SPHA-CLI Analyze..."
    # The 'analyze' command parses all JSON files in the directory and sends them to the SPHA server
    - java -jar ./cli-0.6.0-348.sha.a3b6b55-standalone.jar analyze --toolResultDir . --reportUri http://spha:8080/api/report --repoOrigin https://github.com/fraunhofer-iem/spha-demo
  allow_failure: true
  only:
    - branches
    - merge_requests
  needs:
    - osv-scanner
    - trufflehog