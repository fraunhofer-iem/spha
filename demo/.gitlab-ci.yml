stages:
  - security-scan
  - spha-scan

# Run OSV Scanner
osv-scanner:
  stage: security-scan
  image:
    name: ghcr.io/google/osv-scanner:latest
    entrypoint: [""]  # <--- FORCE ENTRYPOINT RESET
  tags:
    - shared
  script:
    # Added --format=json and redirection to create the actual file
    - /osv-scanner --recursive --format=json . > osv-scanner-report.json
  allow_failure: true
  artifacts:
    when: always
    paths:
      - osv-scanner-report.json
    expire_in: 1 week
    # Note: 'gl-dependency-scanning-report.json' removed.
    # OSV output is not natively compatible with GitLab's Security Dashboard format.
  only:
    - branches
    - merge_requests

# Run TruffleHog
trufflehog:
  stage: security-scan
  image:
    name: trufflesecurity/trufflehog:latest
    entrypoint: [""] # <--- FORCE ENTRYPOINT RESET
  tags:
    - shared
  script:
    - trufflehog git file://. --json --no-update > trufflehog-report.json
  allow_failure: true
  artifacts:
    paths:
      - trufflehog-report.json
    expire_in: 1 week
  only:
    - branches
    - merge_requests

include:
  - component: $CI_SERVER_FQDN/spah/spa-component/spha-cli@1.0.0 # <--- IMPORTANT: REPLACE WITH YOUR COMPONENT version
    inputs:
      stage: spha-scan
