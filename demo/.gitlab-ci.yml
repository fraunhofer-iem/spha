include:
  - component: $CI_SERVER_FQDN/root/spha-component/cli-component@~latest # ADJUST REPO PATH AS REQUIRED
    inputs:
      server_url: "http://spha:8080/api/report"
      tool_result_dir: "."

stages:
  - security-scan
  - spha-result

# Run OSV Scanner
osv-scanner:
  stage: security-scan
  image:
    name: ghcr.io/google/osv-scanner:latest
    entrypoint: [""]  # <--- FORCE ENTRYPOINT RESET
  tags:
    - shared
  script:
    # Added --format=json and redirection to create the actual file
    - /osv-scanner --recursive --format=json . > osv-scanner-report.json
  allow_failure: true
  artifacts:
    when: always
    paths:
      - osv-scanner-report.json
    expire_in: 1 week
    # Note: 'gl-dependency-scanning-report.json' removed.
    # OSV output is not natively compatible with GitLab's Security Dashboard format.
  only:
    - branches
    - merge_requests

# Run TruffleHog
trufflehog:
  stage: security-scan
  image:
    name: trufflesecurity/trufflehog:latest
    entrypoint: [""] # <--- FORCE ENTRYPOINT RESET
  tags:
    - shared
  script:
    - trufflehog git file://. --json --no-update > trufflehog-report.json
  allow_failure: true
  artifacts:
    paths:
      - trufflehog-report.json
    expire_in: 1 week
  only:
    - branches
    - merge_requests

# Run SPHA CLI analysis using the component
spha-cli:
  extends: .spha-cli-analyze
  stage: spha-result
  tags:
    - shared
  needs:
    - osv-scanner
    - trufflehog
  allow_failure: true
  only:
    - branches
    - merge_requests
